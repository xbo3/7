/*! xbo3-signup-bridge v1.2 — auto UI modal + duplicate checks + password confirm */
(function(){'use strict';
  function $(sel, root){return (root||document).querySelector(sel);}
  function $all(sel, root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function val(el){ return (el && el.value ? String(el.value).trim() : ''); }
  function css(h){ var s=document.createElement('style'); s.textContent=h; document.head.appendChild(s); return s; }
  function on(el, ev, fn){ el&&el.addEventListener(ev, fn); }
  function toast(msg){ try{ 
    var t=document.createElement('div'); t.textContent=msg;
    t.style.cssText='position:fixed;left:50%;top:22px;transform:translateX(-50%);background:#0f172a;color:#e5e7eb;padding:10px 12px;border-radius:10px;border:1px solid #334155;box-shadow:0 6px 20px rgba(0,0,0,.36);z-index:999999;font:13px/1.2 system-ui,Segoe UI,Roboto,Arial';
    document.body.appendChild(t); setTimeout(function(){t.remove();},2200);
  }catch(_){ alert(msg);} }

  function readConfig(){
    var tag = document.currentScript || document.querySelector('script[src*="signup.min.js"],script[data-gas-webapp]');
    var cfg = { webapp: "https://script.google.com/macros/s/AKfycbz9zLfI-PI_JrMyDw4OqtNFWq74JLvkuA1ZllKKx1JoZdyBAITRzcHFP-wnUJdgD_r1nQ/exec", sheet: "1aYJkfM5-HmrBNN2FR5nCPGM4SoDaA8kKNhbKcW3bipU", tab: "시트1", target: null };
    if(tag && tag.dataset){ 
      if(tag.dataset.gasWebapp) cfg.webapp = tag.dataset.gasWebapp;
      if(tag.dataset.gasSheet)  cfg.sheet  = tag.dataset.gasSheet;
      if(tag.dataset.gasTab)    cfg.tab    = tag.dataset.gasTab;
      if(tag.dataset.targetForm) cfg.target = tag.dataset.targetForm;
    }
    cfg.gviz = "https://docs.google.com/spreadsheets/d/1aYJkfM5-HmrBNN2FR5nCPGM4SoDaA8kKNhbKcW3bipU/gviz/tq?tqx=out:csv&sheet=%EC%8B%9C%ED%8A%B81";
    return cfg;
  }

  // GAS post helper
  async function postJSON(url, data){ 
    var res = await fetch(url, {method:'POST', mode:'cors', headers:{'Content-Type':'application/json; charset=utf-8'}, body: JSON.stringify(data)});
    var txt = await res.text(); var json=null; try{ json=JSON.parse(txt); }catch(_){}
    return {ok:res.ok, status:res.status, statusText:res.statusText, text:txt, json:json};
  }

  // exists check via GAS (action=exists), fallback to gviz csv
  async function checkExists_GAS(cfg, field, value){
    try {
      var where={}; where[field]=value;
      var resp = await postJSON(cfg.webapp, {action:'exists', sheetId:cfg.sheet, tab:cfg.tab, where:where});
      if(resp.ok && resp.json && typeof resp.json.exists!=='undefined') return !!resp.json.exists;
    } catch(e){}
    return null;
  }
  async function checkExists_CSV(cfg, field, value){
    try {
      var resp = await fetch(cfg.gviz, {mode:'cors'});
      var text = await resp.text();
      if(!resp.ok) return null;
      var lines = text.split(/\r?\n/).filter(Boolean);
      if(!lines.length) return null;
      var header = lines.shift().split(',');
      var idx = header.indexOf(field);
      if(idx<0){
        var map={'user_id':['user_id','userid','id','username'],'phone':['phone','tel','mobile','연락처']};
        var cand = (map[field]||[]);
        for(var i=0;i<cand.length;i++){ var j=header.indexOf(cand[i]); if(j>=0){ idx=j; break; } }
        if(idx<0) return null;
      }
      var target = String(value).toLowerCase();
      for(var i=0;i<lines.length;i++){ var cols=lines[i].split(','); if(cols[idx] && String(cols[idx]).toLowerCase()==target) return true; }
      return false;
    }catch(e){ return null; }
  }
  async function checkExists(cfg, field, value){
    if(!value) return null;
    var a = await checkExists_GAS(cfg, field, value);
    if(a===true || a===false) return a;
    return await checkExists_CSV(cfg, field, value);
  }

  // UI
  function injectModal(){
    css(".xbo3-modal-back{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:saturate(1.2) blur(1.5px);z-index:99998;display:none}"+
        ".xbo3-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(520px,92vw);background:#0b0f14;color:#e5e7eb;border:1px solid #1f2937;border-radius:14px;box-shadow:0 24px 60px rgba(0,0,0,.5);z-index:99999;display:none}"+
        ".xbo3-hd{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1f2937;font:600 15px system-ui,Segoe UI,Roboto,Arial}"+
        ".xbo3-bd{padding:14px 16px}"+
        ".xbo3-row{display:grid;grid-template-columns:110px 1fr 110px;gap:8px;align-items:center;margin:6px 0}"+
        ".xbo3-row.full{grid-template-columns:110px 1fr}"+
        ".xbo3-row label{font-size:12px;color:#9ca3af}"+
        ".xbo3-row input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e5e7eb}"+
        ".xbo3-pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px;border:1px solid #334155}"+
        ".xbo3-pill.ok{background:#052e16;color:#a7f3d0;border-color:#14532d}"+
        ".xbo3-pill.bad{background:#3f1d1d;color:#fecaca;border-color:#7f1d1d}"+
        ".xbo3-btn{padding:8px 10px;border:1px solid #334155;border-radius:10px;background:#0f172a;color:#e5e7eb;cursor:pointer}"+
        ".xbo3-ft{padding:12px 16px;border-top:1px solid #1f2937;display:flex;gap:8px;justify-content:flex-end}"+
        ".xbo3-float{position:fixed;right:14px;bottom:14px;background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:999px;padding:10px 14px;cursor:pointer;z-index:99990}");
    var back=document.createElement('div'); back.className='xbo3-modal-back';
    var box=document.createElement('div'); box.className='xbo3-modal'; box.innerHTML =
      '<div class="xbo3-hd"><span>빠른 가입</span><button class="xbo3-btn xbo3-close">닫기</button></div>'+
      '<div class="xbo3-bd">'+
        '<form id="xbo3Form">'+
          '<div class="xbo3-row"><label>아이디</label><input name="user_id" required placeholder="아이디"><button type="button" class="xbo3-btn" data-field="user_id">중복확인</button></div>'+
          '<div class="xbo3-row full"><label>성함</label><input name="full_name" required placeholder="성함"></div>'+
          '<div class="xbo3-row full"><label>비밀번호</label><input name="password" type="password" required placeholder="비밀번호"></div>'+
          '<div class="xbo3-row full"><label>비밀번호확인</label><input name="password_confirm" type="password" required placeholder="비밀번호확인"></div>'+
          '<div class="xbo3-row"><label>연락처</label><input name="phone" required placeholder="연락처"><button type="button" class="xbo3-btn" data-field="phone">중복확인</button></div>'+
        '</form>'+
      '</div>'+
      '<div class="xbo3-ft"><button class="xbo3-btn xbo3-close">취소</button><button class="xbo3-btn xbo3-submit">가입하기</button></div>';
    document.body.appendChild(back); document.body.appendChild(box);
    return {back:back, box:box, form:$('#xbo3Form', box)};
  }

  function showResult(input, ok, msg){
    var parent = input.closest('.xbo3-row')||input.parentNode;
    var old = parent.querySelector('.xbo3-pill'); if(old) old.remove();
    var s=document.createElement('span'); s.textContent=msg; s.className='xbo3-pill '+(ok?'ok':'bad'); parent.appendChild(s);
    input.dataset.dupOk = ok? '1':'0';
  }
  function samePasswords(a,b){ return val(a) && val(a)===val(b); }

  async function main(){
    var cfg = readConfig();

    // Case 1: developer already has a visible form -> enhance (v1.1 방식)
    if(cfg.target && document.querySelector(cfg.target)){
      // keep existing enhancement behavior (v1.1) by early return: we won't override their UI
      return; 
    }

    // Case 2: auto modal UI
    var ui = injectModal();
    var openers = $all('[data-open-signup], a, button').filter(function(el){
      var t=(el.textContent||'').trim(); return /가입/i.test(t);
    });
    function open(){ ui.back.style.display='block'; ui.box.style.display='block'; }
    function close(){ ui.back.style.display='none'; ui.box.style.display='none'; }
    openers.forEach(function(el){ on(el,'click',function(ev){ open(); }); });
    if(openers.length===0){
      // create floating opener
      var fab=document.createElement('button'); fab.className='xbo3-float'; fab.textContent='가입하기';
      on(fab,'click',function(){ open(); }); document.body.appendChild(fab);
    }
    $all('.xbo3-close', ui.box).forEach(function(b){ on(b,'click',function(){ close(); }); });
    on(ui.back,'click',function(){ close(); });

    // duplicate-check buttons
    on(ui.box,'click',function(ev){
      var btn=ev.target.closest('button[data-field]'); if(!btn) return;
      var field=btn.dataset.field; var input=ui.form.querySelector('[name="'+field+'"]'); if(!input) return;
      var v=val(input); if(!v) return showResult(input,false,'값을 입력하세요');
      btn.disabled=true; var prev=btn.textContent; btn.textContent='확인중…';
      checkExists(cfg, field, v).then(function(exists){
        if(exists===true) showResult(input,false,'이미 사용 중');
        else if(exists===false) showResult(input,true,'사용 가능');
        else showResult(input,false,'확인 실패');
      }).catch(function(){ showResult(input,false,'확인 실패'); })
      .finally(function(){ btn.disabled=false; btn.textContent=prev; });
    });

    // submit
    on($('.xbo3-submit', ui.box),'click', async function(){
      var f = ui.form;
      var user_id = $('[name="user_id"]', f), full_name=$('[name="full_name"]', f), 
          password=$('[name="password"]', f), password_confirm=$('[name="password_confirm"]', f),
          phone=$('[name="phone"]', f);
      if(!samePasswords(password, password_confirm)){ showResult(password_confirm,false,'비밀번호 불일치'); return; }
      if(user_id.dataset.dupOk!=='1' || phone.dataset.dupOk!=='1'){ toast('중복확인을 완료해주세요.'); return; }
      var payload={
        action:'signup', sheetId: cfg.sheet, tab: cfg.tab,
        data:{ user_id: val(user_id), password: val(password), full_name: val(full_name), phone: val(phone), note:'from site' }
      };
      var btn=this; btn.disabled=true; var prev=btn.textContent; btn.textContent='전송중…';
      try{
        var resp = await postJSON(cfg.webapp, payload);
        if(resp.ok){ toast('가입 완료! 시트 저장 성공'); f.reset(); close(); }
        else { toast('서버 오류: '+resp.status+' '+resp.statusText); console.error(resp.text); }
      }catch(e){ toast('요청 실패: '+e.message); }
      finally { btn.disabled=false; btn.textContent=prev; }
    });
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', main); else main();
})();