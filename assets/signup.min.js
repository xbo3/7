/*! xbo3-signup-bridge v1.0.0 — drop-in connector for GAS → Google Sheets (user_db/시트1) */
(function(){'use strict';
  function $(sel, root){return (root||document).querySelector(sel);}
  function $all(sel, root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function readConfig(){ 
    var tag = document.currentScript || $(`script[src*="signup.min.js"]`) || $(`script[data-gas-webapp]`);
    var cfg = { webapp: "https://script.google.com/macros/s/AKfycbz9zLfI-PI_JrMyDw4OqtNFWq74JLvkuA1ZllKKx1JoZdyBAITRzcHFP-wnUJdgD_r1nQ/exec", sheet: "1aYJkfM5-HmrBNN2FR5nCPGM4SoDaA8kKNhbKcW3bipU", tab: "시트1", selector: null, toast: true };
    if(tag && tag.dataset){ 
      if(tag.dataset.gasWebapp) cfg.webapp = tag.dataset.gasWebapp;
      if(tag.dataset.gasSheet)  cfg.sheet  = tag.dataset.gasSheet;
      if(tag.dataset.gasTab)    cfg.tab    = tag.dataset.gasTab;
      if(tag.dataset.targetForm) cfg.selector = tag.dataset.targetForm;
    }
    return cfg;
  }
  function findForm(selector){
    if(selector) return $(selector);
    var c = ['form#signup','form[name="signup"]','form[data-signup]','form[action*="signup"]','form[action*="join"]','form[action*="register"]','form'];
    for(var i=0;i<c.length;i++){ var f=$(c[i]); if(f) return f; } return null;
  }
  function normalizeFields(form){
    var map = { user_id:null, password:null };
    var inputs = $all('input,textarea,select', form);
    inputs.forEach(function(el){
      var name = (el.name||'').toLowerCase();
      var id   = (el.id||'').toLowerCase();
      var val  = (el.type==='checkbox') ? (el.checked? (el.value||true) : false) : (el.value||'');
      if(!map.user_id && /^(user[_-]?id|userid|id|login|username)$/.test(name||id)) map.user_id = val;
      if(!map.password && /^(password|pw|pass|passwd)$/.test(name||id)) map.password = val;
    });
    var extra={};
    inputs.forEach(function(el){
      if(!el.name) return;
      var key=el.name;
      var val=(el.type==='checkbox')?(el.checked? (el.value||true) : false):(el.value||'');
      if(key==='user_id'||key==='password') return;
      extra[key]=val;
    });
    return {core: map, extra: extra};
  }
  function toast(msg){ try{ 
    var t=document.createElement('div'); t.textContent=msg;
    t.style.cssText='position:fixed;left:50%;top:24px;transform:translateX(-50%);background:#0f172a;color:#e5e7eb;padding:10px 14px;border-radius:10px;border:1px solid #334155;box-shadow:0 6px 20px rgba(0,0,0,.4);z-index:99999;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:13px;';
    document.body.appendChild(t); setTimeout(function(){t.remove();}, 2400);
  }catch(_){
    alert(msg);
  } }
  async function postJSON(url, data, headers){ 
    var res = await fetch(url, {method:'POST', mode:'cors', headers: Object.assign({'Content-Type':'application/json; charset=utf-8'}, headers||{}), body: JSON.stringify(data)});
    var txt = await res.text(); var body = null; try{ body = JSON.parse(txt); }catch(_){}
    return { ok: res.ok, status: res.status, statusText: res.statusText, text: txt, json: body };
  }
  function wire(){ 
    var cfg = readConfig(); var form = findForm(cfg.selector);
    if(!form){ console.warn('[signup-bridge] 대상 폼을 찾지 못했습니다. data-target-form로 지정하세요.'); return; }
    var submitting=false;
    form.addEventListener('submit', async function(ev){
      ev.preventDefault(); if(submitting) return; submitting=true;
      var submitBtn = $('button[type="submit"]', form) || $('button', form);
      if(submitBtn){ submitBtn.disabled=true; submitBtn.dataset.prevText=submitBtn.textContent; submitBtn.textContent='전송 중…'; }
      try{
        var fields = normalizeFields(form);
        var payload = { action:'signup', sheetId: cfg.sheet, tab: cfg.tab, data: { user_id: fields.core.user_id||'', password: fields.core.password||'', note:'from site' }, extra: fields.extra };
        if(!payload.data.user_id || !payload.data.password){ toast('아이디/비밀번호 입력을 확인해주세요.'); return; }
        var resp = await postJSON(cfg.webapp, payload);
        if(resp.ok){ toast('가입 완료! 시트 저장 성공'); form.reset(); } else { toast('서버 오류: '+resp.status+' '+resp.statusText); console.error(resp.text); }
      }catch(e){ console.error(e); toast('요청 실패: '+e.message); }
      finally{ if(submitBtn){ submitBtn.textContent=submitBtn.dataset.prevText||'제출'; submitBtn.disabled=false; } submitting=false; }
    });
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', wire); else wire();
  window.GAS_signup = async function(data){ var cfg=readConfig(); return postJSON(cfg.webapp, Object.assign({action:'signup', sheetId:cfg.sheet, tab:cfg.tab}, data||{})); };
})();
