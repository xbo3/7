<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>모바일 회원가입 · 완성본 v2</title>
  <style>
    :root {
      --bg:#0a0f14; --panel:#0f141b; --border:#253041; --text:#e5e7eb; --muted:#9ca3af; --primary:#22a6f2;
      --ok-bg:#065f46; --ok-b:#16a34a; --ok-t:#e7f8ef; --bad-bg:#7f1d1d; --bad-b:#ef4444; --bad-t:#fee2e2;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif}
    header{position:static;top:0;background:#0b1016;border-bottom:1px solid var(--border)}
    .bar{max-width:100%;margin:0 auto;padding:16px;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:800}
    main{max-width:100%;margin:0 auto;padding:24px;display:flex;align-items:center;justify-content:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--primary);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#121826;border:1px solid var(--border);color:var(--text)}
    .btn.ok{background:var(--ok-b) !important; color:#fff !important; border-color:var(--ok-b) !important}
    .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#0f172a;color:#e5e7eb;padding:10px 12px;border-radius:10px;border:1px solid #334155;box-shadow:0 6px 20px rgba(0,0,0,.36);z-index:10000;font-size:13px}
    /* modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;z-index:9998}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(520px, 94vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.5);display:none;z-index:9999}
    .modal .hd{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
    .modal .bd{padding:14px 16px}
    .modal .ft{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .row{display:grid;grid-template-columns:100px 1fr 110px;gap:8px;align-items:center;margin:10px 0}
    .row.full{grid-template-columns:100px 1fr}
    label{font-size:12px;color:var(--muted)}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0c1117;color:var(--text)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px;border:1px solid var(--border)}
    .ok-pill{background:var(--ok-bg);border-color:var(--ok-b);color:var(--ok-t)}
    .bad-pill{background:var(--bad-bg);border-color:var(--bad-b);color:var(--bad-t)}
  </style>
</head>
<body>
  <header><div class="bar"><div class="brand">GGDEMY · Mobile</div><button id="openJoin" class="btn">회원가입</button></div></header>
  <main>
    <p style="opacity:.7">(메인 중앙) 버튼을 눌러 테스트하세요.</p>
  </main>

  <!-- 가입 모달 -->
  <div id="backdrop" class="backdrop"></div>
  <div id="joinModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
    <div class="hd">
      <div id="joinTitle">회원가입</div>
      <button id="closeJoin" class="btn ghost" style="padding:8px 12px;border-radius:10px">닫기</button>
    </div>
    <div class="bd">
      <form id="signupForm" autocomplete="off">
        <div class="row">
          <label>아이디</label>
          <input name="user_id" required placeholder="아이디를 입력하세요" inputmode="latin" autocapitalize="off">
          <button type="button" class="btn ghost dup" data-field="user_id">중복확인</button>
        </div>
        <div class="row full">
          <label>성함</label>
          <input name="full_name" required placeholder="성함을 입력하세요">
        </div>
        <div class="row full">
          <label>비밀번호</label>
          <input name="password" type="password" required placeholder="비밀번호를 입력하세요">
        </div>
        <div class="row full">
          <label>비밀번호확인</label>
          <input name="password_confirm" type="password" required placeholder="비밀번호를 다시 입력하세요">
        </div>
        <div class="row">
          <label>연락처</label>
          <input name="phone" required placeholder="연락처를 입력하세요" inputmode="tel">
          <button type="button" class="btn ghost dup" data-field="phone">중복확인</button>
        </div>
      </form>
    </div>
    <div class="ft">
      <button id="cancelJoin" class="btn ghost">취소</button>
      <button id="submitJoin" class="btn">회원가입</button>
    </div>
  </div>

<script>
const WEB_APP  = "https://script.google.com/macros/s/AKfycbz9zLfI-PI_JrMyDw4OqtNFWq74JLvkuA1ZllKKx1JoZdyBAITRzcHFP-wnUJdgD_r1nQ/exec";
const SHEET_ID = "1aYJkfM5-HmrBNN2FR5nCPGM4SoDaA8kKNhbKcW3bipU";
const TAB      = "시트1";
const GVIZ     = "https://docs.google.com/spreadsheets/d/1aYJkfM5-HmrBNN2FR5nCPGM4SoDaA8kKNhbKcW3bipU/gviz/tq?tqx=out:csv&sheet=%EC%8B%9C%ED%8A%B81";

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const val = el => (el && el.value ? String(el.value).trim() : "");
const samePw = (a,b) => val(a) && val(a) === val(b);
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2200); }
function setOk(btn, ok){ btn.classList.toggle('ok', !!ok); btn.textContent = ok ? 'O' : '중복확인'; }
function pill(input, ok, msg){ const parent=input.closest('.row')||input.parentNode; const old=parent.querySelector('.pill'); if(old) old.remove(); const s=document.createElement('span'); s.className='pill '+(ok?'ok-pill':'bad-pill'); s.textContent=msg; parent.appendChild(s); }
function resetDupState(input, btn){ input.dataset.dupOk='0'; setOk(btn,false); const p=input.closest('.row')||input.parentNode; const old=p.querySelector('.pill'); if(old) old.remove(); }

/* Modal open/close */
const ui={open:$('#openJoin'), close:$('#closeJoin'), cancel:$('#cancelJoin'), back:$('#backdrop'), modal:$('#joinModal'), form:$('#signupForm'), submit:$('#submitJoin')};
function openModal(){ui.back.style.display='block'; ui.modal.style.display='block';}
function closeModal(){ui.back.style.display='none'; ui.modal.style.display='none';}
ui.open.addEventListener('click', openModal); ui.back.addEventListener('click', closeModal); ui.close.addEventListener('click', closeModal); ui.cancel.addEventListener('click', closeModal);

/* Networking */
async function postJSON(url, data){ const res=await fetch(url,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json; charset=utf-8'},body:JSON.stringify(data)}); const txt=await res.text(); let json=null; try{json=JSON.parse(txt);}catch(e){} return {ok:res.ok,status:res.status,statusText:res.statusText,text:txt,json}; }
async function existsGas(field,value){ try{ const where={}; where[field]=value; const r=await postJSON(WEB_APP,{action:'exists',sheetId:SHEET_ID,tab:TAB,where}); if(r.ok && r.json && typeof r.json.exists!=='undefined') return !!r.json.exists; }catch(e){} return null; }
async function existsCsv(field,value){ try{ const res=await fetch(GVIZ,{mode:'cors'}); const text=await res.text(); if(!res.ok) return null; const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return null; const header=lines.shift().split(','); const alias={user_id:['user_id','userid','id','username'], phone:['phone','tel','mobile','연락처']}; let idx=header.indexOf(field); if(idx<0){ for(const k of (alias[field]||[])){ const j=header.indexOf(k); if(j>=0){ idx=j; break; } } if(idx<0) return null; } const target=String(value).toLowerCase(); for(const ln of lines){ const cols=ln.split(','); if(cols[idx] && String(cols[idx]).toLowerCase()===target) return true; } return false; }catch(e){ return null; } }
async function exists(field,value){ const a=await existsGas(field,value); if(a===true||a===false) return a; return await existsCsv(field,value); }

/* Duplicate check buttons */
$$('.dup', ui.modal).forEach(btn=>{
  const input = ui.form.querySelector('[name="'+btn.dataset.field+'"]');
  if(!input) return;
  input.dataset.dupOk='0';
  input.addEventListener('input', ()=>resetDupState(input, btn));
  btn.addEventListener('click', async ()=>{
    const v=val(input); if(!v) { pill(input,false,'값을 입력하세요'); return; }
    btn.disabled=true; const prev=btn.textContent; btn.textContent='확인중…';
    try{
      const ex = await exists(btn.dataset.field, v);
      if(ex===true){ input.dataset.dupOk='0'; setOk(btn,false); pill(input,false,'이미 사용 중'); }
      else if(ex===false){ input.dataset.dupOk='1'; setOk(btn,true); pill(input,true,'사용 가능'); }
      else { input.dataset.dupOk='0'; setOk(btn,false); pill(input,false,'확인 실패'); }
    }catch(e){ input.dataset.dupOk='0'; setOk(btn,false); pill(input,false,'확인 실패'); }
    finally{ btn.disabled=false; btn.textContent=prev; }
  });
});

/* Submit with re-validation */
ui.submit.addEventListener('click', async ()=>{
  const user_id = ui.form.user_id; const full_name=ui.form.full_name; const password=ui.form.password; const password_confirm=ui.form.password_confirm; const phone=ui.form.phone;
  if(!samePw(password,password_confirm)){ pill(password_confirm,false,'비밀번호 불일치'); return; }
  // Re-validate duplicates server-side
  const [uEx, pEx] = await Promise.all([exists('user_id', val(user_id)), exists('phone', val(phone))]);
  if(uEx!==false){ toast('아이디 중복확인을 통과하지 못했습니다.'); return; }
  if(pEx!==false){ toast('연락처 중복확인을 통과하지 못했습니다.'); return; }

  const payload={ action:'signup', sheetId:SHEET_ID, tab:TAB, data:{ user_id:val(user_id), full_name:val(full_name), password:val(password), phone:val(phone), note:'v2 complete' } };
  ui.submit.disabled=true; const prev=ui.submit.textContent; ui.submit.textContent='전송중…';
  try{
    const resp = await postJSON(WEB_APP, payload);
    if(resp.ok){ toast('가입 완료! 시트 저장 성공'); ui.form.reset(); closeModal(); }
    else{ toast('서버 오류: '+resp.status+' '+resp.statusText); console.error(resp.text); }
  }catch(e){ toast('요청 실패: '+e.message); }
  finally{ ui.submit.disabled=false; ui.submit.textContent=prev; }
});
</script>
</body>
</html>
